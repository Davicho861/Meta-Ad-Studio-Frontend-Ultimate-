<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inyectar Seed - El Brindis Sincronizado</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#0f172a;color:#e6eef8}
      .card{background:#07203a;padding:32px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);max-width:720px;text-align:center}
      h1{margin:0 0 12px;font-size:20px}
      p{margin:8px 0 20px}
      button{background:#06b6d4;border:none;color:#042a37;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer}
      .success{font-size:18px;color:#9be8ff;margin:12px 0}
      .thumb{max-width:100%;height:200px;object-fit:cover;border-radius:8px;margin-bottom:12px}
    </style>
  </head>
  <body>
  <div class="card">
      <img id="thumb" class="thumb" alt="thumbnail" src="/images/campaign-examples/coca-cola-drones-paris.jpg" />
      <h1>Inyección: El Brindis Sincronizado</h1>
      <p id="status">Preparando inyección...</p>
      <div id="actions" style="display:none">
        <div class="success">¡Éxito! La campaña 'El Brindis Sincronizado' ha sido inyectada en tu navegador.</div>
        <button id="openApp">Ver Campaña en Meta Ad Studio</button>
      </div>
    </div>

  <!-- Visible hook used by E2E tests to assert seed execution -->
  <pre id="result" style="background:transparent;color:#9be8ff;border:none">Running seed...</pre>

    <script>
      async function run() {
        const status = document.getElementById('status')
        try {
          const res = await fetch('/seed/celestia-campaign-seed.json', {cache: 'no-store'})
          if (!res.ok) throw new Error('No se encontró el archivo de seed: ' + res.status)
          const data = await res.json()

          // Key used by app to read templates
          const key = 'meta_ad_studio_templates_v1'

          // If app already has templates, merge conservatively
          try {
            const existing = JSON.parse(localStorage.getItem(key) || '{}')
            if (existing && Array.isArray(existing.templates)) {
              // prepend seed templates to be first
              const merged = { templates: [...data.templates, ...existing.templates] }
              localStorage.setItem(key, JSON.stringify(merged))
            } else {
              localStorage.setItem(key, JSON.stringify(data))

                  // Update confirmation element so E2E tests can assert the seed ran
                  try {
                    const pre = document.getElementById('result');
                    if (pre) pre.textContent = `Seed injected to localStorage key: ${key}`;
                  } catch (e) {
                    // noop
                  }
            }
          } catch(e) {
            // fallback to overwrite
            localStorage.setItem(key, JSON.stringify(data))
          }

          status.textContent = ''
          document.getElementById('actions').style.display = 'block'

          // Only redirect automatically if the 'noredirect' query param is not present
          const params = new URLSearchParams(window.location.search || '');
          const shouldRedirect = !params.has('noredirect');

          document.getElementById('openApp').addEventListener('click', ()=>{
            const tryPaths = [ '/', '/index.html', '/app', '/#/', '/#'];
            if (shouldRedirect) window.location.href = tryPaths[0];
          })

          if (shouldRedirect) {
            setTimeout(() => {
              try { window.location.href = '/campaigns'; } catch (e) { window.location.href = '/'; }
            }, 1200);
          }
        } catch(err) {
          status.textContent = 'Error: ' + err.message
          console.error(err)
        }
      }
      run()
    </script>
  </body>
</html>
